{% extends "base.html" %}
{% load static %}
{% block title %}Admin Console | Workspace Manager{% endblock %}
{% block content %}
  <section class="card">
    <h2>Administrative Tools</h2>
    <p class="note-text">
      Use these tools to override seat assignments, schedule block-out zones, and monitor who is
      currently seated in the building. All actions take effect immediately.
    </p>
  </section>

  {% if messages %}
    <div class="flash-messages">
      {% for message in messages %}
        <div class="flash-message {{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <section class="card">
    <div class="card-header">
      <h3>Floor Plan Layout</h3>
      <p class="note-text">
        Select cells to assign departments, update labels, or clear areas. Changes are saved
        immediately for the interactive floor plan and assignment tools.
      </p>
    </div>
    <div class="layout-editor">
      <div class="floorplan-wrapper">
        <div
          class="floorplan-canvas"
          id="layout-canvas"
          data-rows="{{ grid_rows }}"
          data-columns="{{ grid_columns }}"
        ></div>
      </div>
      <div class="layout-controls">
        <div class="selection-summary">
          <p id="layout-selection-info" class="note-text">No cells selected.</p>
          <ul id="layout-selection-list" class="selection-list"></ul>
        </div>
        <div class="admin-mode-toggle" role="tablist">
          <button
            type="button"
            class="admin-mode-button active"
            data-admin-mode="layout"
            role="tab"
            aria-selected="true"
          >
            Layout
          </button>
          <button
            type="button"
            class="admin-mode-button"
            data-admin-mode="assignment"
            role="tab"
            aria-selected="false"
          >
            Seat assignment
          </button>
          <button
            type="button"
            class="admin-mode-button"
            data-admin-mode="block"
            role="tab"
            aria-selected="false"
          >
            Block zone
          </button>
        </div>
        <div class="combined-toggle">
          <label class="combined-toggle-control" for="combined-mode-toggle">
            <input type="checkbox" id="combined-mode-toggle" name="combined-mode-toggle" checked />
            <span>
              <strong>Update layout and seat assignments together</strong>
              <small id="combined-mode-help">
                Saving layout changes will also save seat assignments when a name is provided.
              </small>
            </span>
          </label>
        </div>

        <div class="mode-panel active" data-mode-panel="layout" role="tabpanel">
          <form id="layout-form" class="form-grid">
            <div>
              <label for="layout-department">Department</label>
              <select id="layout-department" name="department" required>
                <option value="">Select department</option>
                {% for department in departments %}
                  <option value="{{ department.pk }}">{{ department.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label for="layout-label">Label</label>
              <input type="text" id="layout-label" name="label" placeholder="Desk label" />
            </div>
            <div>
              <label for="layout-fill">Fill color override</label>
              <input type="text" id="layout-fill" name="fill_color" placeholder="#5B9BD5" />
              <p class="note-text">Leave blank to use the department color.</p>
            </div>
            <div>
              <label for="layout-notes">Notes</label>
              <textarea id="layout-notes" name="notes" rows="2"></textarea>
            </div>
            <div class="layout-actions">
              <button type="submit" class="button primary">Assign selected cells</button>
              <button type="button" class="button secondary" id="layout-clear">Clear selected cells</button>
            </div>
          </form>
          <div id="layout-feedback" class="note-text"></div>
        </div>

        <div class="mode-panel" data-mode-panel="assignment" role="tabpanel" aria-hidden="true">
          <form id="assignment-form" class="form-grid" data-default-start="{{ now|date:'Y-m-d\TH:i' }}">
            <p id="assignment-selection-info" class="note-text">Select at least one assignable desk.</p>
            <div>
              <label for="assignment-name">Employee name</label>
              <input type="text" id="assignment-name" name="assignee_name" placeholder="Jordan Smith" required />
            </div>
            <div class="form-grid two-col">
              <div>
                <label for="assignment-type">Assignment type</label>
                <select id="assignment-type" name="assignment_type">
                  <option value="desk">Desk</option>
                </select>
              </div>
              <div>
                <label for="assignment-duration">Duration</label>
                <select id="assignment-duration" name="duration_choice">
                  <option value="temporary">Temporary</option>
                  <option value="permanent">Permanent</option>
                </select>
              </div>
            </div>
            <div class="form-grid two-col">
              <div>
                <label for="assignment-start">Start</label>
                <input type="datetime-local" id="assignment-start" name="start" />
              </div>
              <div>
                <label for="assignment-end">End</label>
                <input type="datetime-local" id="assignment-end" name="end" />
              </div>
            </div>
            <div>
              <label for="assignment-note">Notes</label>
              <textarea id="assignment-note" name="note" rows="2"></textarea>
            </div>
            <div>
              <label for="assignment-created-by">Recorded by</label>
              <input type="text" id="assignment-created-by" name="created_by" placeholder="Facility team" />
            </div>
            <div class="layout-actions">
              <button type="submit" class="button primary" id="assignment-submit">Save assignment</button>
            </div>
          </form>
          <div id="assignment-feedback" class="note-text"></div>
        </div>

        <div class="mode-panel" data-mode-panel="block" role="tabpanel" aria-hidden="true">
          <form id="block-form" class="form-grid" data-default-start="{{ now|date:'Y-m-d\TH:i' }}">
            <p id="block-selection-info" class="note-text">Select the desks you want to block.</p>
            <div>
              <label for="block-name">Zone name</label>
              <input type="text" id="block-name" name="name" placeholder="Renovation zone" required />
            </div>
            <div class="form-grid two-col">
              <div>
                <label for="block-duration">Duration</label>
                <select id="block-duration" name="duration_choice">
                  <option value="temporary">Temporary</option>
                  <option value="permanent">Permanent</option>
                </select>
              </div>
              <div>
                <label for="block-start">Start</label>
                <input type="datetime-local" id="block-start" name="start" />
              </div>
            </div>
            <div>
              <label for="block-end">End</label>
              <input type="datetime-local" id="block-end" name="end" />
            </div>
            <div>
              <label for="block-reason">Reason / notes</label>
              <textarea id="block-reason" name="reason" rows="2"></textarea>
            </div>
            <div>
              <label for="block-created-by">Recorded by</label>
              <input type="text" id="block-created-by" name="created_by" placeholder="Construction team" />
            </div>
            <div class="layout-actions">
              <button type="submit" class="button danger" id="block-submit">Save block-out zone</button>
            </div>
          </form>
          <div id="block-feedback" class="note-text"></div>
        </div>
      </div>
    </div>
  </section>

  <div class="grid" style="margin-top: 2rem;">
    <section class="card">
      <h3>Active Assignments</h3>
      {% if active_assignments %}
        <ul class="assignment-list">
          {% for assignment in active_assignments %}
            <li class="assignment-item">
              <strong>{{ assignment.assignee_name }}</strong>
              <div class="assignment-meta">
                {% if assignment.assignment_type == 'desk' and assignment.desk %}
                  <span>Desk: {{ assignment.desk.label }}</span>
                  <span>Department: {{ assignment.desk.department.name }}</span>
                {% else %}
                  <span>Location: WFH</span>
                {% endif %}
                <span>{{ assignment.duration_display }}</span>
              </div>
              <form
                method="post"
                action="{% url 'floorplan:end-assignment' assignment.pk %}"
                style="margin-top: 0.75rem;"
              >
                {% csrf_token %}
                <button type="submit" class="button secondary">End assignment</button>
              </form>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="note-text">No active assignments at this time.</p>
      {% endif %}
    </section>

    <section class="card">
      <h3>Active Block-Out Zones</h3>
      {% if active_blocks %}
        <ul class="block-list">
          {% for block in active_blocks %}
            <li class="block-item">
              <strong>{{ block.name }}</strong>
              <div class="assignment-meta">
                <span>{{ block.desks.count }} desks affected</span>
                {% if block.is_permanent %}
                  <span class="badge warning">Permanent</span>
                {% elif block.end %}
                  <span>Ends {{ block.end|date:'M d, Y H:i' }}</span>
                {% endif %}
              </div>
              {% if block.reason %}
                <p class="note-text">{{ block.reason }}</p>
              {% endif %}
              <form
                method="post"
                action="{% url 'floorplan:delete-block-zone' block.pk %}"
                style="margin-top: 0.75rem;"
              >
                {% csrf_token %}
                <button type="submit" class="button secondary">Remove block-out zone</button>
              </form>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="note-text">There are no active block-out zones.</p>
      {% endif %}
    </section>
  </div>
  <script id="layout-desk-data" type="application/json">{{ layout_desks|safe }}</script>
{% endblock %}
{% block extra_scripts %}
  {{ block.super }}
  <script src="{% static 'js/admin_floorplan.js' %}"></script>
{% endblock %}
